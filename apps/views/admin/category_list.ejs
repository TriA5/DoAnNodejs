<%- include('partials/head') %>
<%- include('partials/sidebar') %>

<div class="flex-grow-1 p-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìÇ Qu·∫£n l√Ω Th·ªÉ lo·∫°i</h2>
        <a href="/admin-ui/categories/create" class="btn btn-primary">+ Th√™m Th·ªÉ lo·∫°i</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 30%">T√™n th·ªÉ lo·∫°i</th>
                        <th>M√¥ t·∫£</th>
                        <th style="width: 15%">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="cateTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('user_token');
        
        // 1. Load danh s√°ch
        async function loadCategories() {
            try {
                const res = await fetch('/admin/category', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.status) {
                    const tbody = document.getElementById('cateTableBody');
                    tbody.innerHTML = ''; 

                    data.data.forEach(cat => {
                        const row = `
                            <tr>
                                <td><strong>${cat.Name}</strong></td>
                                <td>${cat.Description || "Kh√¥ng c√≥ m√¥ t·∫£"}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" onclick='editCategory(${JSON.stringify(cat)})'>‚úèÔ∏è S·ª≠a</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat._id}')">üóëÔ∏è X√≥a</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    alert(data.message);
                }
            } catch (err) { console.error(err); }
        }

        // 2. X√≥a th·ªÉ lo·∫°i
        async function deleteCategory(id) {
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a th·ªÉ lo·∫°i n√†y?")) return;

            try {
                const res = await fetch('/admin/category/delete/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                if(data.status) {
                    alert("ƒê√£ x√≥a!");
                    loadCategories(); // Load l·∫°i b·∫£ng
                } else {
                    alert("L·ªói: " + data.message);
                }
            } catch(e) {
                alert("L·ªói k·∫øt n·ªëi!");
            }
        }

        // 3. M·ªü modal ƒë·ªÉ s·ª≠a
        function editCategory(cat) {
            document.getElementById('editCategoryId').value = cat._id;
            document.getElementById('editCategoryName').value = cat.Name;
            document.getElementById('editCategoryDesc').value = cat.Description || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        }

        // 4. L∆∞u ch·ªânh s·ª≠a
        async function saveEdit() {
            const id = document.getElementById('editCategoryId').value;
            const name = document.getElementById('editCategoryName').value.trim();
            const desc = document.getElementById('editCategoryDesc').value.trim();

            if(!name) {
                alert('T√™n th·ªÉ lo·∫°i kh√¥ng ƒë∆∞·ª£c tr·ªëng!');
                return;
            }

            try {
                const res = await fetch('/admin/category/update/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ Name: name, Description: desc })
                });
                const data = await res.json();

                if(data.status) {
                    alert('‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
                    loadCategories();
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch(e) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        loadCategories();
    </script>

</div>

<!-- Modal S·ª≠a Th·ªÉ Lo·∫°i -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Ch·ªânh s·ª≠a Th·ªÉ Lo·∫°i</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCategoryId">
                <div class="mb-3">
                    <label class="form-label">T√™n th·ªÉ lo·∫°i <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editCategoryName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">M√¥ t·∫£</label>
                    <textarea class="form-control" id="editCategoryDesc" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">üíæ L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>