<%- include('partials/head') %>
<%- include('partials/sidebar') %>

<div class="flex-grow-1 p-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üéûÔ∏è Qu·∫£n L√Ω T·∫≠p Phim</h2>
        <a href="/admin-ui/episodes/upload" class="btn btn-primary">üì§ Upload T·∫≠p M·ªõi</a>
    </div>

    <!-- B·ªô l·ªçc phim -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">L·ªçc theo phim:</label>
                    <select class="form-select" id="filterMovie">
                        <option value="">-- T·∫•t c·∫£ phim --</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng danh s√°ch t·∫≠p -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>T√™n t·∫≠p</th>
                        <th>Thu·ªôc phim</th>
                        <th>ƒê∆∞·ªùng d·∫´n</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="episodeTableBody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const token = localStorage.getItem('user_token');
    let allEpisodes = [];
    let allMovies = [];

    // Load danh s√°ch phim cho filter
    async function loadMovies() {
        try {
            const res = await fetch('/admin/movie', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            if (data.status) {
                allMovies = data.data;
                const select = document.getElementById('filterMovie');
                
                allMovies.forEach(movie => {
                    const option = document.createElement('option');
                    option.value = movie._id;
                    option.textContent = movie.Name;
                    select.appendChild(option);
                });
            }
        } catch (err) {
            console.error(err);
        }
    }

    // Load t·∫•t c·∫£ t·∫≠p phim
    async function loadAllEpisodes() {
        try {
            const tbody = document.getElementById('episodeTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">‚è≥ ƒêang t·∫£i...</td></tr>';

            allEpisodes = [];

            // Load t·∫≠p phim c·ªßa t·ª´ng phim
            for (const movie of allMovies) {
                const res = await fetch('/admin/episode/list/' + movie._id, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.status && data.data.length > 0) {
                    data.data.forEach(ep => {
                        ep.MovieInfo = movie; // Th√™m th√¥ng tin phim
                        allEpisodes.push(ep);
                    });
                }
            }

            renderEpisodes(allEpisodes);
        } catch (err) {
            console.error(err);
            document.getElementById('episodeTableBody').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
        }
    }

    // Hi·ªÉn th·ªã danh s√°ch t·∫≠p
    function renderEpisodes(episodes) {
        const tbody = document.getElementById('episodeTableBody');
        
        if (episodes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ t·∫≠p phim n√†o</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        episodes.forEach(ep => {
            const date = new Date(ep.CreatedTime).toLocaleString('vi-VN');
            const row = `
                <tr>
                    <td><strong>${ep.Name}</strong></td>
                    <td>${ep.MovieInfo?.Name || 'N/A'}</td>
                    <td><code class="text-primary">${ep.Path}</code></td>
                    <td>${date}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="playVideo('${ep.Path}')">‚ñ∂Ô∏è Xem</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEpisode('${ep._id}', '${ep.Name}')">üóëÔ∏è X√≥a</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // L·ªçc theo phim
    document.getElementById('filterMovie').addEventListener('change', function() {
        const movieId = this.value;
        
        if (movieId === '') {
            renderEpisodes(allEpisodes);
        } else {
            const filtered = allEpisodes.filter(ep => ep.MovieInfo._id === movieId);
            renderEpisodes(filtered);
        }
    });

    // Xem video
    function playVideo(path) {
        window.open(path, '_blank');
    }

    // X√≥a t·∫≠p phim
    async function deleteEpisode(id, name) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${name}"?`)) return;

        try {
            const res = await fetch('/admin/episode/delete/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            if (data.status) {
                alert('‚úÖ ƒê√£ x√≥a!');
                loadAllEpisodes();
            } else {
                alert('‚ùå ' + data.message);
            }
        } catch (err) {
            alert('L·ªói k·∫øt n·ªëi!');
        }
    }

    // Init
    (async function() {
        await loadMovies();
        await loadAllEpisodes();
    })();
</script>

<%- include('partials/footer') %>
