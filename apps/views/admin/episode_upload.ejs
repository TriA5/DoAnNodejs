<%- include('partials/head') %>
<%- include('partials/sidebar') %>

<div class="flex-grow-1 p-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸï¸ Upload Táº­p Phim</h2>
        <a href="/admin-ui/episodes" class="btn btn-secondary">â† Quay láº¡i</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                
                <!-- Chá»n phim -->
                <div class="mb-3">
                    <label class="form-label">Chá»n Phim <span class="text-danger">*</span></label>
                    <select class="form-select" id="movieSelect" required>
                        <option value="">-- Chá»n phim --</option>
                    </select>
                </div>

                <!-- TÃªn táº­p -->
                <div class="mb-3">
                    <label class="form-label">TÃªn Táº­p <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="episodeName" placeholder="VD: Táº­p 1, Full Movie..." required>
                </div>

                <!-- Chá»n file video -->
                <div class="mb-3">
                    <label class="form-label">File Video <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="videoFile" accept="video/*" required>
                    <small class="text-muted">Há»— trá»£: MP4, MKV, AVI... (Tá»‘i Ä‘a 2GB)</small>
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" class="mb-3" style="display: none;">
                    <label class="form-label">Äang táº£i lÃªn...</label>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>

                <!-- NÃºt submit -->
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    ğŸ“¤ Upload vÃ  Chuyá»ƒn Äá»•i
                </button>
                
                <div id="statusMessage" class="mt-3"></div>
            </form>
        </div>
    </div>

</div>

<script>
    const token = localStorage.getItem('user_token');

    // Load danh sÃ¡ch phim
    async function loadMovies() {
        try {
            const res = await fetch('/admin/movie', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            if (data.status) {
                const select = document.getElementById('movieSelect');
                data.data.forEach(movie => {
                    const option = document.createElement('option');
                    option.value = movie._id;
                    option.textContent = movie.Name;
                    select.appendChild(option);
                });
            }
        } catch (err) {
            console.error(err);
            alert('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch phim');
        }
    }

    // Xá»­ lÃ½ upload
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const movieId = document.getElementById('movieSelect').value;
        const episodeName = document.getElementById('episodeName').value;
        const videoFile = document.getElementById('videoFile').files[0];

        if (!movieId || !episodeName || !videoFile) {
            alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
            return;
        }

        // Kiá»ƒm tra kÃ­ch thÆ°á»›c file (2GB = 2147483648 bytes)
        if (videoFile.size > 2147483648) {
            alert('âŒ File quÃ¡ lá»›n! Tá»‘i Ä‘a 2GB');
            return;
        }

        const formData = new FormData();
        formData.append('video', videoFile);
        formData.append('MovieId', movieId);
        formData.append('Name', episodeName);

        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');

        // Disable nÃºt submit
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'â³ Äang xá»­ lÃ½...';
        progressContainer.style.display = 'block';
        statusMessage.innerHTML = '<div class="alert alert-info">â³ Äang upload vÃ  chuyá»ƒn Ä‘á»•i video... Vui lÃ²ng Ä‘á»£i!</div>';

        try {
            const xhr = new XMLHttpRequest();

            // Theo dÃµi tiáº¿n trÃ¬nh upload
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                }
            });

            // Xá»­ lÃ½ khi hoÃ n thÃ nh
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.status) {
                        statusMessage.innerHTML = '<div class="alert alert-success">âœ… Upload thÃ nh cÃ´ng! Video Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i.</div>';
                        
                        // Reset form sau 2s
                        setTimeout(() => {
                            document.getElementById('uploadForm').reset();
                            progressContainer.style.display = 'none';
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'ğŸ“¤ Upload vÃ  Chuyá»ƒn Äá»•i';
                            statusMessage.innerHTML = '';
                        }, 2000);
                    } else {
                        throw new Error(response.message);
                    }
                } else {
                    throw new Error('Lá»—i server: ' + xhr.status);
                }
            });

            // Xá»­ lÃ½ lá»—i
            xhr.addEventListener('error', function() {
                statusMessage.innerHTML = '<div class="alert alert-danger">âŒ Lá»—i káº¿t ná»‘i!</div>';
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'ğŸ“¤ Upload vÃ  Chuyá»ƒn Äá»•i';
            });

            // Gá»­i request
            xhr.open('POST', '/admin/episode/create');
            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            xhr.send(formData);

        } catch (error) {
            console.error(error);
            statusMessage.innerHTML = '<div class="alert alert-danger">âŒ ' + error.message + '</div>';
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ğŸ“¤ Upload vÃ  Chuyá»ƒn Äá»•i';
        }
    });

    // Load movies khi trang vá»«a má»Ÿ
    loadMovies();
</script>

<%- include('partials/footer') %>
