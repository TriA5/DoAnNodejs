<%- include('partials/head') %>
<%- include('partials/sidebar') %>

<div class="flex-grow-1 p-4">

    <div class="mb-3">
        <a href="/admin-ui/movies" class="btn btn-secondary">&larr; Quay l·∫°i</a>
    </div>

    <h2>‚ûï Th√™m Phim M·ªõi</h2>

    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <form id="addMovieForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">T√™n phim (Ti·∫øng Vi·ªát) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="Name" required placeholder="Ng∆∞·ªùi Nh·ªán">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">T√™n g·ªëc</label>
                        <input type="text" class="form-control" id="OriginName" placeholder="Spider Man">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Th·ªÉ lo·∫°i <span class="text-danger">*</span></label>
                        <select class="form-select" id="CategoryId" required>
                            <option value="">-- Ch·ªçn --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">NƒÉm ph√°t h√†nh</label>
                        <input type="number" class="form-control" id="Year" value="2024">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Lo·∫°i phim</label>
                        <select class="form-select" id="Type">
                            <option value="single">Phim l·∫ª</option>
                            <option value="series">Phim b·ªô</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-select" id="Status">
                            <option value="ongoing">ƒêang chi·∫øu</option>
                            <option value="completed">Ho√†n th√†nh</option>
                            <option value="trailer">Trailer</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">·∫¢nh Poster (Upload)</label>
                        <input type="file" class="form-control" id="ThumbFile" accept="image/*">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ho·∫∑c Link ·∫¢nh (URL)</label>
                        <input type="text" class="form-control" id="ThumbUrl" placeholder="https://...">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Th·ªùi l∆∞·ª£ng</label>
                    <input type="text" class="form-control" id="Time" placeholder="VD: 120 ph√∫t">
                </div>

                <div class="mb-3">
                    <label class="form-label">N·ªôi dung t√≥m t·∫Øt</label>
                    <textarea class="form-control" id="Content" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-success w-100">üíæ L∆∞u Phim</button>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('user_token');
        if (!token) window.location.href = '/login-page';

        // Load Th·ªÉ lo·∫°i
        async function loadCategories() {
            try {
                const res = await fetch('/admin/category', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                if(data.status) {
                    const select = document.getElementById('CategoryId');
                    data.data.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat._id;
                        option.text = cat.Name;
                        select.appendChild(option);
                    });
                }
            } catch(e) { console.error(e); }
        }
        loadCategories();

        // X·ª≠ l√Ω Submit
        document.getElementById('addMovieForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. D√ôNG FORMDATA ƒê·ªÇ G·ª¨I FILE
            const formData = new FormData();
            
            formData.append('Name', document.getElementById('Name').value);
            formData.append('OriginName', document.getElementById('OriginName').value);
            formData.append('CategoryId', document.getElementById('CategoryId').value);
            formData.append('Year', document.getElementById('Year').value);
            formData.append('Type', document.getElementById('Type').value);
            formData.append('Status', document.getElementById('Status').value);
            formData.append('Time', document.getElementById('Time').value);
            formData.append('Content', document.getElementById('Content').value);
            
            // X·ª≠ l√Ω ·∫£nh: ∆Øu ti√™n file upload, n·∫øu kh√¥ng th√¨ l·∫•y URL text
            const fileInput = document.getElementById('ThumbFile');
            if(fileInput.files.length > 0) {
                formData.append('ThumbFile', fileInput.files[0]);
            } else {
                formData.append('ThumbUrl', document.getElementById('ThumbUrl').value);
            }

            try {
                const res = await fetch('/admin/movie/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                        // L∆ØU √ù: KH√îNG ƒê∆Ø·ª¢C set 'Content-Type': 'application/json' 
                        // ƒê·ªÉ tr√¨nh duy·ªát t·ª± ƒë·ªông set multipart/form-data
                    },
                    body: formData
                });

                const data = await res.json();
                
                if(data.status) {
                    alert("‚úÖ Th√™m phim th√†nh c√¥ng!");
                    window.location.href = '/admin-ui/movies'; 
                } else {
                    alert("‚ùå L·ªói: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("L·ªói k·∫øt n·ªëi server!");
            }
        });

        function logout() { localStorage.removeItem('user_token'); window.location.href='/login-page'; }
    </script>
</div>
<%- include('partials/footer') %>