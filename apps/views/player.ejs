<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem Phim Online</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: #0f0f0f; 
            color: #fff; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background: rgba(0,0,0,0.9) !important;
        }
        .video-container {
            max-width: 1200px;
            margin: 20px auto;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        video { 
            width: 100%;
            display: block;
            background: #000;
        }
        .video-info {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 0 0 15px 15px;
        }
        .video-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .controls-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            transition: transform 0.3s;
        }
        .btn-custom:hover {
            transform: scale(1.05);
            color: white;
        }
        .quality-badge {
            background: #28a745;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
   <%- include('partials/navbar') %>

    <!-- Main Content -->
    <div class="container">
        <div class="video-container">
            <div style="position: relative;">
                <video id="video" controls autoplay></video>
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                </div>
            </div>
            
            <div class="video-info">
                <div class="video-title" id="videoTitle">
                    <i class="fas fa-film"></i> ƒêang t·∫£i...
                </div>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <span class="quality-badge">
                        <i class="fas fa-hd-video"></i> HLS Streaming
                    </span>
                    <span class="text-muted">
                        <i class="fas fa-shield-alt"></i> M√£ h√≥a AES-128
                    </span>
                    <span class="text-success" id="statusText">
                        <i class="fas fa-circle"></i> S·∫µn s√†ng
                    </span>
                </div>
                
                <div class="controls-bar">
                    <button class="btn btn-custom" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i> To√†n m√†n h√¨nh
                    </button>
                    <button class="btn btn-custom" onclick="changeSpeed(0.5)">
                        <i class="fas fa-backward"></i> 0.5x
                    </button>
                    <button class="btn btn-custom" onclick="changeSpeed(1.0)">
                        <i class="fas fa-play"></i> 1x
                    </button>
                    <button class="btn btn-custom" onclick="changeSpeed(1.5)">
                        <i class="fas fa-forward"></i> 1.5x
                    </button>
                    <button class="btn btn-custom" onclick="changeSpeed(2.0)">
                        <i class="fas fa-fast-forward"></i> 2x
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. L·∫§Y TOKEN T·ª™ STORAGE
        var token = localStorage.getItem('user_token');

        // 2. CHECK B·∫¢O M·∫¨T
        if (!token) {
            alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem.");
            window.location.href = "/login-page";
        }

        var video = document.getElementById('video');
        var loadingOverlay = document.getElementById('loadingOverlay');
        
        // 3. L·∫•y ƒë∆∞·ªùng d·∫´n video t·ª´ localStorage (ƒë∆∞·ª£c set t·ª´ trang movie_detail)
        var videoPath = localStorage.getItem('current_video_path');
        var videoName = localStorage.getItem('current_video_name');

        if (!videoPath) {
            alert("Kh√¥ng t√¨m th·∫•y video! Vui l√≤ng ch·ªçn t·∫≠p phim.");
            window.location.href = "/movies";
        }

        // Update title
        document.getElementById('videoTitle').textContent = videoName || 'ƒêang xem phim';
        
        // T·∫°o full URL
        var baseUrl = window.location.origin + videoPath;
        var videoSrc = baseUrl + "?token=" + token;

        console.log("üé¨ ƒêang load video:", videoPath);

        // Show loading
        loadingOverlay.style.display = 'flex';
        document.getElementById('statusText').innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...';

        if (Hls.isSupported()) {
            var hls = new Hls({
                xhrSetup: function(xhr, url) {
                    if (url.indexOf("token=") === -1) {
                        var newUrl = url + (url.indexOf("?") === -1 ? "?" : "&") + "token=" + token;
                        xhr.open("GET", newUrl, true);
                    }
                }
            });
            
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                loadingOverlay.style.display = 'none';
                document.getElementById('statusText').innerHTML = '<i class="fas fa-check-circle"></i> ƒêang ph√°t';
                video.play().catch(e => {
                    console.log("C·∫ßn t∆∞∆°ng t√°c ƒë·ªÉ ph√°t");
                    document.getElementById('statusText').innerHTML = '<i class="fas fa-hand-pointer"></i> Click ƒë·ªÉ ph√°t';
                });
            });
            
            hls.on(Hls.Events.ERROR, function (event, data) {
                console.error("HLS Error:", data);
                if(data.response && data.response.code === 403) {
                    alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    logout();
                } else if (data.fatal) {
                    loadingOverlay.style.display = 'none';
                    document.getElementById('statusText').innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói ph√°t video';
                    alert("L·ªói ph√°t video! Vui l√≤ng th·ª≠ l·∫°i.");
                }
            });

            // Update status when playing
            video.addEventListener('playing', function() {
                document.getElementById('statusText').innerHTML = '<i class="fas fa-play-circle"></i> ƒêang ph√°t';
            });

            video.addEventListener('pause', function() {
                document.getElementById('statusText').innerHTML = '<i class="fas fa-pause-circle"></i> T·∫°m d·ª´ng';
            });

            video.addEventListener('waiting', function() {
                document.getElementById('statusText').innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...';
            });
        }
        else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoSrc;
            video.addEventListener('loadedmetadata', function() {
                loadingOverlay.style.display = 'none';
                document.getElementById('statusText').innerHTML = '<i class="fas fa-check-circle"></i> ƒêang ph√°t';
                video.play();
            });
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.log("Fullscreen error:", err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Change playback speed
        function changeSpeed(speed) {
            video.playbackRate = speed;
            document.getElementById('statusText').innerHTML = `<i class="fas fa-tachometer-alt"></i> T·ªëc ƒë·ªô ${speed}x`;
        }

        // Logout
        function logout() {
            localStorage.removeItem('user_token');
            localStorage.removeItem('current_video_path');
            localStorage.removeItem('current_video_name');
            document.cookie = 'user_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = "/login-page";
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    video.paused ? video.play() : video.pause();
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
                case 'ArrowRight':
                    video.currentTime += 10;
                    break;
                case 'ArrowLeft':
                    video.currentTime -= 10;
                    break;
            }
        });
    </script>

</body>
</html>